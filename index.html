<!DOCTYPE html>
<html>
<head>
	<title> Local Guide </title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://fb.me/react-0.14.7.js"> </script>
	<script src="https://fb.me/react-dom-0.14.7.js"> </script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.25/browser.min.js"></script>
	<script src="https://cdn.firebase.com/js/client/1.0.17/firebase.js"></script>
	<style>
		body {
			margin-top: 30px;
		}

		a.delete{
			color: red;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="row">
			<div class="col-md-12"> 
				<div id="feed"></div>
			</div>
		</div>  <!--row -->
	</div> <!-- container -->

	<script type="text/babel">
		
		const Feed = React.createClass({
			getInitialState: function() {
				return {
					text: '',
					isEdit: 0,
					todos: [
						{	
							id: 1,
							text: 'Meeting At Work'
						},
						{	
							id: 2,
							text: 'Bring Kids To School'
						},
						{	
							id: 3,
							text: 'Food Shopping'
						}
					]
				}
			},
			componentWillMount: function(){
				this.firebaseRef = new Firebase('https://localguide-2d198.firebaseio.com/tours');
				const that = this;
				this.firebaseRef.once("value", function (snapshot){
					const todos = [];
					snapshot.forEach(function(data){
						const todo = {
							id: data.val().id,
							text: data.val().text
						}
						todos.push(todo);
						that.setState({todos: todos});
					});
				});
			},
			render: function() {
				return (
						<div>
							<TodoForm 
							{...this.state}
							changeText = {this.handleChangeText}
							onTodoAdd = {this.handleTodoAdd}
							onTodoUpdate = {this.handleTodoUpdate}/>
							<TodoList 
							{...this.state}
							todos={this.state.todos} 
							onDelete={this.handleTodoDelete}
							editTodo={this.handleTodoEdit}
							 />
							}
						</div>
				)

			},
			handleTodoAdd: function(text) {
				const newTodo = {
					id: this.state.todos.length + 1,
					text: text
				}
				this.firebaseRef.push(newTodo);
				this.setState ({todos: this.state.todos.concat(newTodo)});
			},
			handleTodoDelete: function(todo) {
				const todos = this.state.todos;
				for(let i=0; i < todos.length; i++){
					if(todos[i].id == todo.id) {
						todos.splice(i, 1);
					}
				}
				this.setState({todos: todos})
			},
			handleTodoEdit: function(todo) {
				this.setState({
					text: todo.text,
					isEdit: todo.id
				});
			},
			handleChangeText: function(text) {
				this.setState({text: text});
			},
			handleTodoUpdate: function(todo) {
				const todos = this.state.todos;
				for(let i=0; i < todos.length; i++){
					if(todos[i].id == todo.id) {
						todos.splice(i, 1);
					}
				}
				todos.push(todo);
				this.setState({todos: todos});
			},

		
			
		});
		const TodoForm = React.createClass({
			
			render: function() {
				return (
						<div>
							<form onSubmit={this.onSubmit}>
								<div className='form-group'>
									<label> Todo Text </label>
									<input type='text' ref='text' value={this.props.text} onChange={this.onChange} className='form-control' />
								</div>
							</form>
						</div>
				)

			},
			
			onChange: function(e) {
				this.props.changeText(e.target.value);
			},

			onSubmit: function(e) {
				e.preventDefault();
				const text = this.refs.text.value.trim();
				if (!text) {
					alert('Please enter a todo');
					return;
				}
				if(this.props.isEdit) {
					const updatedTodo = {
						id: this.props.isEdit,
						text: text
					}
					this.props.onTodoUpdate(updatedTodo)
				} else {
					this.props.onTodoAdd(text);
				}

				this.refs.text.value = '';
			}
			
		});
		const TodoList = React.createClass({
			
			render: function() {
				return (
						<ul className="list-group">
							{
								this.props.todos.map(todo => {
									return <li className="list-group-item" todo={todo} key={todo.id}> <span onClick = {this.editTodo.bind(this, todo)}> {todo.text} </span> <a onClick={this.onDelete.bind(this, todo)} className="delete" href="#">x</a>
									</li>
								})
							}
						</ul>
				)

			},

			onDelete: function(todo) {
				this.props.onDelete(todo);
			},
			editTodo: function(todo){
				this.props.editTodo(todo);
			}
			
		});

		

		ReactDOM.render (
			<Feed />,
			document.getElementById('feed')
		);
	</script>
</body>
</html>